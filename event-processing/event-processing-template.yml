AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "A template to create all the Event Processing infrastructure."

Parameters:
  CodeSigningConfigArn:
    Type: String
    Default: "none"
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"
  Environment:
    Description: "The environment type"
    Type: "String"
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
    ConstraintDescription: must be dev, build, staging, integration or production

Conditions:
  SetPermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
  UseCodeSigning:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"
  IsProductionOrStaging: !And
    - !Not [!Equals [ !Ref Environment, dev]]
    - !Not [!Equals [ !Ref Environment, build]]

Globals:
  Function:
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - SetPermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    Architectures:
      - x86_64

Resources:
  epSNSTopic:
    Properties:
      TopicName: !Sub
        - "EventProcessorSNSTopic-${EnvironmentName}"
        - EnvironmentName: !Ref Environment
    Type: "AWS::SNS::Topic"

  SNSSubscribePolicy:
    Type: "AWS::SNS::TopicPolicy"
    Properties:
      PolicyDocument:
        Id: SNSSubscribePolicy
        Version: 2012-10-17
        Statement:
          - Sid: SNSSubscribePolicy-1
            Effect: Allow
            Action:
              - 'sns:Subscribe'
            Principal:
              AWS:
                - '{{resolve:ssm:AuditAccountARN}}'
            Resource: !Ref epSNSTopic
      Topics:
      - !Ref epSNSTopic

  SNSPublishPolicy:
    DependsOn:
      - epSNSTopic
      - KBVLambdaAccessRole
      - IPVLambdaAccessRole
      - SPOTLambdaAccessRole
    Type: AWS::IAM::Policy
    Properties:
      Roles:
        - !Ref KBVLambdaAccessRole
        - !Ref IPVLambdaAccessRole
        - !Ref SPOTLambdaAccessRole
      PolicyName: sns_publish_policy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'sns:Publish'
            Resource: !Sub
              - 'arn:aws:sns:${AWS::Region}:${AWS::AccountId}:${topicName}'
              - topicName: !GetAtt epSNSTopic.TopicName

  KBVEventProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/EventProcessorFunction-KBV"

  KBVEventProcessorFunction:
    DependsOn:
      - KBVEventProcessorLogGroup
      - KBVLambdaAccessRole
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: "EventProcessorFunction-KBV"
      CodeUri: ../event-processing/event-processor
      PackageType: Zip
      Handler: app.handler
      Runtime: nodejs14.x
      Role: !GetAtt KBVLambdaAccessRole.Arn
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
        - app.ts

  KBVEventInvokeConfig:
    DependsOn:
      - SNSPublishPolicy
      - KBVEventProcessorFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      FunctionName: !Ref KBVEventProcessorFunction
      Qualifier: "$LATEST"
      MaximumEventAgeInSeconds: 600
      MaximumRetryAttempts: 2
      DestinationConfig:
        OnSuccess:
          Destination: !Ref epSNSTopic

  KBVEventProcessorUnknownFieldsErrorMetric:
    DependsOn:
      - KBVEventProcessorFunction
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: "WARN UNKNOWN FIELDS"
      LogGroupName: "/aws/lambda/EventProcessorFunction-KBV"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: "lambda/di/txma/errors"
          MetricName: "Unknown Fields KBV"

  KBVEventProcessorUnknownFieldsAlarm:
    DependsOn:
      - KBVEventProcessorUnknownFieldsErrorMetric
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "KBV Event Processor Unknown Fields Alarm"
      AlarmName: "UnknownFieldsAlarm-KBV"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 86400
      Threshold: 1
      MetricName: "Unknown Fields KBV"
      Namespace: "lambda/di/txma/errors"

  KBVEventProcessorRequiredFieldsErrorMetric:
    DependsOn:
      - KBVEventProcessorFunction
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: "ERROR VALIDATION ERROR"
      LogGroupName: "/aws/lambda/EventProcessorFunction-KBV"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: "lambda/di/txma/errors"
          MetricName: "Validation Errors KBV"

  KBVEventProcessorRequiredFieldsAlarm:
    DependsOn:
      - KBVEventProcessorRequiredFieldsErrorMetric
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "KBV Event Processor Required Fields Alarm"
      AlarmName: "RequiredFieldsAlarm-KBV"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 86400
      Threshold: 1
      MetricName: "Validation Errors KBV"
      Namespace: "lambda/di/txma/errors"

  KBVLambdaAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "LambdaAccessRole-KBV"
      PermissionsBoundary: !If
        - SetPermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"

#  KBVLambdaEventSourceMapping:
#    DependsOn:
#      - KBVEventProcessorFunction
#    Type: AWS::Lambda::EventSourceMapping
#    Condition: IsProductionOrStaging
#    Properties:
#      EventSourceArn:
#        - !FindInMap [KBVQueueARN, Environment, !Ref Environment]
#      FunctionName: !Ref KBVEventProcessorFunction

#  KBVAddressLambdaEventSourceMapping:
#    DependsOn:
#      - KBVEventProcessorFunction
#    Type: AWS::Lambda::EventSourceMapping
#    Condition: IsProductionOrStaging
#    Properties:
#      EventSourceArn:
#        - !FindInMap [KBVAddressQueueARN, Environment, !Ref Environment]
#      FunctionName: !Ref KBVEventProcessorFunction

#  KBVFraudLambdaEventSourceMapping:
#    DependsOn:
#      - KBVEventProcessorFunction
#    Type: AWS::Lambda::EventSourceMapping
#    Condition: IsProductionOrStaging
#    Properties:
#      EventSourceArn:
#        - !FindInMap [KBVFraudQueueARN, Environment, !Ref Environment]
#      FunctionName: !Ref KBVEventProcessorFunction

#  KBVKMSPolicy:
#    DependsOn:
#      - KBVLambdaAccessRole
#    Type: AWS::IAM::Policy
#    Properties:
#      Roles:
#        - !Ref KBVLambdaAccessRole
#      PolicyName: kbv_kms_policy
#      PolicyDocument:
#        Version: 2012-10-17
#        Statement:
#          - Effect: Allow
#            Action:
#              - 'kms:Encrypt'
#              - 'kms:Decrypt'
#              - 'kms:ReEncrypt*'
#              - 'kms:GenerateDataKey*'
#              - 'kms:DescribeKey'
#            Resource:
#              - !Ref KbvKmsArn
#              - !Ref KbvAddressKmsArn
#              - !Ref KbvFraudKmsArn

  IPVEventProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/EventProcessorFunction-IPV"

  IPVEventProcessorFunction:
    DependsOn:
      - IPVEventProcessorLogGroup
      - IPVLambdaAccessRole
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: "EventProcessorFunction-IPV"
      CodeUri: ../event-processing/event-processor
      PackageType: Zip
      Handler: app.handler
      Runtime: nodejs14.x
      Role: !GetAtt IPVLambdaAccessRole.Arn
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - app.ts

  IPVEventInvokeConfig:
    DependsOn:
      - SNSPublishPolicy
      - IPVEventProcessorFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      FunctionName: !Ref IPVEventProcessorFunction
      Qualifier: "$LATEST"
      MaximumEventAgeInSeconds: 600
      MaximumRetryAttempts: 2
      DestinationConfig:
        OnSuccess:
          Destination: !Ref epSNSTopic

  IPVEventProcessorUnknownFieldsErrorMetric:
    DependsOn:
      - IPVEventProcessorFunction
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: "WARN UNKNOWN FIELDS"
      LogGroupName: "/aws/lambda/EventProcessorFunction-IPV"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: "lambda/di/txma/errors"
          MetricName: "Unknown Fields IPV"

  IPVEventProcessorUnknownFieldsAlarm:
    DependsOn:
      - IPVEventProcessorUnknownFieldsErrorMetric
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "IPV Event Processor Unknown Fields Alarm"
      AlarmName: "UnknownFieldsAlarm-IPV"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 86400
      Threshold: 1
      MetricName: "Unknown Fields IPV"
      Namespace: "lambda/di/txma/errors"

  IPVEventProcessorRequiredFieldsErrorMetric:
    DependsOn:
      - IPVEventProcessorFunction
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: "ERROR VALIDATION ERROR"
      LogGroupName: "/aws/lambda/EventProcessorFunction-IPV"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: "lambda/di/txma/errors"
          MetricName: "Validation Errors IPV"

  IPVEventProcessorRequiredFieldsAlarm:
    DependsOn:
      - IPVEventProcessorRequiredFieldsErrorMetric
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "IPV Event Processor Required Fields Alarm"
      AlarmName: "RequiredFieldsAlarm-IPV"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 86400
      Threshold: 1
      MetricName: "Validation Errors IPV"
      Namespace: "lambda/di/txma/errors"

  IPVLambdaAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "LambdaAccessRole-IPV"
      PermissionsBoundary: !If
        - SetPermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"

  IPVCoreLambdaEventSourceMapping:
    DependsOn:
      - IPVEventProcessorFunction
    Type: AWS::Lambda::EventSourceMapping
    Condition: IsProductionOrStaging
    Properties:
      EventSourceArn:
        - !FindInMap [IPVCoreQueueARN, Environment, !Ref Environment]
      FunctionName: !Ref IPVEventProcessorFunction

  IPVPassportLambdaEventSourceMapping:
    DependsOn:
      - IPVEventProcessorFunction
    Type: AWS::Lambda::EventSourceMapping
    Condition: IsProductionOrStaging
    Properties:
      EventSourceArn:
        - !FindInMap [IPVPassportQueueARN, Environment, !Ref Environment]
      FunctionName: !Ref IPVEventProcessorFunction

  IPVKMSPolicy:
    DependsOn:
      - IPVLambdaAccessRole
    Type: AWS::IAM::Policy
    Condition: IsProductionOrStaging
    Properties:
      Roles:
        - !Ref IPVLambdaAccessRole
      PolicyName: ipv_kms_policy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'kms:Encrypt'
              - 'kms:Decrypt'
              - 'kms:ReEncrypt*'
              - 'kms:GenerateDataKey*'
              - 'kms:DescribeKey'
            Resource:
              - IPVCoreKmsArn
              - IPVPassportKmsArn

  SPOTEventProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/EventProcessorFunction-SPOT"

  SPOTEventProcessorFunction:
    DependsOn:
      - SPOTEventProcessorLogGroup
      - SPOTLambdaAccessRole
    Type: "AWS::Serverless::Function"
    Properties:
      FunctionName: "EventProcessorFunction-SPOT"
      CodeUri: ../event-processing/event-processor
      PackageType: Zip
      Handler: app.handler
      Runtime: nodejs14.x
      Role: !GetAtt SPOTLambdaAccessRole.Arn
    Metadata: # Manage esbuild properties
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: "es2020"
        Sourcemap: true
        EntryPoints:
          - app.ts

  SPOTEventInvokeConfig:
    DependsOn:
      - SNSPublishPolicy
      - SPOTEventProcessorFunction
    Type: AWS::Lambda::EventInvokeConfig
    Properties:
      FunctionName: !Ref SPOTEventProcessorFunction
      Qualifier: "$LATEST"
      MaximumEventAgeInSeconds: 600
      MaximumRetryAttempts: 2
      DestinationConfig:
        OnSuccess:
          Destination: !Ref epSNSTopic

  SPOTEventProcessorUnknownFieldsErrorMetric:
    DependsOn:
      - SPOTEventProcessorFunction
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: "WARN UNKNOWN FIELDS"
      LogGroupName: "/aws/lambda/EventProcessorFunction-SPOT"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: "lambda/di/txma/errors"
          MetricName: "Unknown Fields SPOT"

  SPOTEventProcessorUnknownFieldsAlarm:
    DependsOn:
      - SPOTEventProcessorUnknownFieldsErrorMetric
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "SPOT Event Processor Unknown Fields Alarm"
      AlarmName: "UnknownFieldsAlarm-SPOT"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 86400
      Threshold: 1
      MetricName: "Unknown Fields SPOT"
      Namespace: "lambda/di/txma/errors"

  SPOTEventProcessorRequiredFieldsErrorMetric:
    DependsOn:
      - SPOTEventProcessorFunction
    Type: AWS::Logs::MetricFilter
    Properties:
      FilterPattern: "ERROR VALIDATION ERROR"
      LogGroupName: "/aws/lambda/EventProcessorFunction-SPOT"
      MetricTransformations:
        - MetricValue: "1"
          MetricNamespace: "lambda/di/txma/errors"
          MetricName: "Validation Errors SPOT"

  SPOTEventProcessorRequiredFieldsAlarm:
    DependsOn:
      - SPOTEventProcessorRequiredFieldsErrorMetric
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmDescription: "SPOT Event Processor Required Fields Alarm"
      AlarmName: "RequiredFieldsAlarm-SPOT"
      ComparisonOperator: GreaterThanThreshold
      EvaluationPeriods: 1
      Statistic: Sum
      Period: 86400
      Threshold: 1
      MetricName: "Validation Errors SPOT"
      Namespace: "lambda/di/txma/errors"

  SPOTLambdaAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: "LambdaAccessRole-SPOT"
      PermissionsBoundary: !If
        - SetPermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: ''
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AWSLambdaSQSQueueExecutionRole"

#  SPOTLambdaEventSourceMapping:
#    DependsOn:
#      - SPOTEventProcessorFunction
#    Type: AWS::Lambda::EventSourceMapping
#    Condition: IsProductionOrStaging
#    Properties:
#      EventSourceArn:
#        - !FindInMap [SPOTQueueARN, Environment, !Ref Environment]
#      FunctionName: !Ref SPOTEventProcessorFunction

#  SPOTKMSPolicy:
#    DependsOn:
#      - SPOTLambdaAccessRole
#    Type: AWS::IAM::Policy
#    Properties:
#      Roles:
#        - !Ref SPOTLambdaAccessRole
#      PolicyName: spot_kms_policy
#      PolicyDocument:
#        Version: 2012-10-17
#        Statement:
#          - Effect: Allow
#            Action:
#              - 'kms:Encrypt'
#              - 'kms:Decrypt'
#              - 'kms:ReEncrypt*'
#              - 'kms:GenerateDataKey*'
#              - 'kms:DescribeKey'
#            Resource: !Ref SpotKmsArn